<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" th:href="@{/icon/ikon.jpg}" type="image/x-icon">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <title>Profil</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <header>
        <nav>
            <img th:src="@{/icon/ikon.jpg}" alt="logo" class="logo">
            <span class="logo-text">Lelang hitam</span>
        </nav>
        <nav>
            <a href="/beranda" class="menu">Beranda</a>
            <a href="/lelang" class="menu">Lelang</a>
            <a href="/barang" class="menu">Barang</a>
            <div class="dropdown">
                <a class="menu">Transaksi</a>
                <div class="dropdown-content">
                <a href="/transaksi-penjual">Penjual</a>
                <a href="/transaksi-pembeli">Pembeli</a>
                </div>
            </div>
            <a href="/chat" class="menu">Chat</a>
        </nav>
        <nav>
            <a href="/profil"><img th:src="@{${userAtribute.user.fotoProfil}}" alt="Foto Profil" class="foto-profil"></a>
            <form action="/logout" method="delete">
                <button class="button" type="submit">keluar</button>
            </form>
        </nav>
    </header>
    <main>
        <div class="main">
            <div class="templateform">
                <div class="register">
                    <div class="informasiAkun">
                        <img th:src="@{${userAtribute.user.fotoProfil}}" class="profil-foto">
                        <form th:action="@{/profil}" method="POST" th:object="${userAtribute}" class="formInformasiAkun" enctype="multipart/form-data">
                            <span class="judulInformasiAkun">Profil</span>
                            <input class="input" type="text" th:field="*{user.nama}" placeholder="Nama" required>
                            <input class="input" type="email" th:field="*{user.email}" placeholder="Email" required>
                            <input class="input" type="text" th:field="*{user.username}" placeholder="Username" required readonly>
                            <input class="input" type="date" th:field="*{user.tanggalLahir}">
                            <input class="input" type="text" th:field="*{user.nomorTelepon}" placeholder="Nomor HP" required>
                            <input type="file" name="file" class="input"/>
                            <select id="provinsi" th:field="*{alamat.provinsi}" required class="inputoption"></select>
                            <select id="kabupaten" th:field="*{alamat.kota}" required class="inputoption"></select>
                            <select id="kecamatan" th:field="*{alamat.kecamatan}" required class="inputoption"> </select>
                            <select id="kelurahan" th:field="*{alamat.desa}" required class="inputoption"></select>
                            <textarea th:field="*{alamat.detail}" placeholder="detail alamat" class="input"></textarea>
                            <button class="button" type="submit">Simpan</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>       
    </main>
    <footer>

    </footer>
    <script>
        $(document).ready(function() {
            const API_KEY = 'c8645226-7050-554e-fc01-5d3972d8';
            let selectedProvinsiId = `[[${userAtribute.alamat.provinsi}]]`;
            let selectedKabupatenId = `[[${userAtribute.alamat.kota}]]`;
            let selectedKecamatanId = `[[${userAtribute.alamat.kecamatan}]]`;
            let selectedKelurahanId = `[[${userAtribute.alamat.desa}]]`;

            $.ajax({
                url: 'https://api.goapi.io/regional/provinsi',
                method: 'GET',
                headers: { 'X-API-KEY': API_KEY },
                success: function(response) {
                    let provinsi = $('#provinsi');
                    provinsi.empty();
                    provinsi.append($('<option></option>').val('').text('Pilih Provinsi'));
            
                    if(response.data) {
                        $.each(response.data, function(index, item) {
                            let option = $('<option></option>').val(item.id).text(item.name);
                            if(item.id == selectedProvinsiId) {
                                option.prop('selected', true);
                                loadKabupaten(item.id); 
                            }
                            provinsi.append(option);
                        });
                    }
                }
            });

            $('#provinsi').change(function() {
                let provinsiId = $(this).val();
                if (provinsiId) {
                    loadKabupaten(provinsiId);
                } else {
                    $('#kabupaten').hide();
                    $('#kecamatan').hide();
                    $('#kelurahan').hide();
                }
            });

            function loadKabupaten(provinsiId) {
                $.ajax({
                    url: `https://api.goapi.io/regional/kota?provinsi_id=${provinsiId}`,
                    method: 'GET',
                    headers: { 'X-API-KEY': API_KEY },
                    success: function(response) {
                        let kabupaten = $('#kabupaten');
                        kabupaten.empty();
                        kabupaten.append($('<option></option>').val('').text('Pilih Kabupaten'));
                        kabupaten.show();

                        if (response.data) {
                            $.each(response.data, function(index, item) {
                                let option = $('<option></option>').val(item.id).text(item.name);
                                if (item.id == selectedKabupatenId) {
                                    option.prop('selected', true);
                                    loadKecamatan(item.id); 
                                }
                                kabupaten.append(option);
                            });
                        }
                    }
                });
            }

            $('#kabupaten').change(function() {
                let kabupatenId = $(this).val();
                if (kabupatenId) {
                    loadKecamatan(kabupatenId);
                } else {
                    $('#kecamatan').hide();
                    $('#kelurahan').hide();
                }
            });

            function loadKecamatan(kabupatenId) {
                $.ajax({
                    url: `https://api.goapi.io/regional/kecamatan?kota_id=${kabupatenId}`,
                    method: 'GET',
                    headers: { 'X-API-KEY': API_KEY },
                    success: function(response) {
                        let kecamatan = $('#kecamatan');
                        kecamatan.empty();
                        kecamatan.append($('<option></option>').val('').text('Pilih Kecamatan'));
                        kecamatan.show();

                        if (response.data) {
                            $.each(response.data, function(index, item) {
                                let option = $('<option></option>').val(item.id).text(item.name);
                                if (item.id == selectedKecamatanId) {
                                    option.prop('selected', true);
                                    loadKelurahan(item.id); 
                                }
                                kecamatan.append(option);
                            });
                        }
                    }
                });
            }

            $('#kecamatan').change(function() {
                let kecamatanId = $(this).val();
                if (kecamatanId) {
                    loadKelurahan(kecamatanId);
                } else {
                    $('#kelurahan').hide();
                }
            });

            function loadKelurahan(kecamatanId) {
                $.ajax({
                    url: `https://api.goapi.io/regional/kelurahan?kecamatan_id=${kecamatanId}`,
                    method: 'GET',
                    headers: { 'X-API-KEY': API_KEY },
                    success: function(response) {
                        let kelurahan = $('#kelurahan');
                        kelurahan.empty();
                        kelurahan.append($('<option></option>').val('').text('Pilih Kelurahan'));
                        kelurahan.show();

                        if (response.data) {
                            $.each(response.data, function(index, item) {
                                let option = $('<option></option>').val(item.id).text(item.name);
                                if (item.id == selectedKelurahanId) {
                                    option.prop('selected', true);
                                }
                                kelurahan.append(option);
                            });
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>